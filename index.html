<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Homer</title>

  <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAAZklEQVRYhe3WMQ6AIBQF0W+F4/iZruI4OAoLE21dY4yQ8CvkF4H5b0CRgZk1v40D4A14A54CA+gCDKADMICeAAPoAgygAzCADsAAugAD6AAMoAswgA7AADoAA+gCDKADMICeAAP4A2932wKjM7B9zwAAAABJRU5ErkJggg==">

  <meta name="theme-color" content="#0f172a">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
   
  <script src="https://cdnjs.cloudflare.com/ajax/libs/nosleep/0.12.0/NoSleep.min.js"></script>

  <style>
    :root{
      --bg:#0f172a; --muted:#94a3b8; --text:#e5e7eb;
      --accent:#22c55e; --accent-2:#60a5fa; --border:rgba(255,255,255,.12);
      --card-a: rgba(255,255,255,.06); --card-b: rgba(255,255,255,.03);
      --shadow:0 24px 60px rgba(0,0,0,.45); --radius:18px; --countdown-track: rgba(255,255,255,.18);
      --tb: 88px;
    }
    *{box-sizing:border-box}
    html, body{min-height:100%;height:auto;margin:0;-webkit-text-size-adjust:100%}
    body{
      background:
        radial-gradient(1400px 700px at 50% -200px, #1f2937 0%, var(--bg) 55%),
        linear-gradient(180deg, rgba(96,165,250,.05), rgba(34,197,94,.04));
      color:var(--text);
      font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      padding:28px 14px calc(var(--tb) + env(safe-area-inset-bottom, 0px));
      display:grid; place-items:start center;
      transition: background 0.5s ease; 
    }
    
    /* === ZEN MODE OVERRIDES === */
    body.zen-active {
        background: #000;
        place-items: center;
        padding: 0;
    }
    /* Hide everything in Zen Mode */
    body.zen-active .hero, 
    body.zen-active .tabs, 
    body.zen-active .toolbar, 
    body.zen-active .site-footer, 
    body.zen-active #tab-home,
    body.zen-active #tab-saved,
    body.zen-active #tab-pomodoro,
    body.zen-active #tab-focuslab,
    body.zen-active #tab-investing,
    body.zen-active #tab-tools,
    body.zen-active .ambient-section,
    body.zen-active .focus-grid-wrapper { 
        display: none !important; 
    }
    
    /* Show Zen Overlay */
    body.zen-active #zen-overlay {
        display: flex !important;
    }

    .shell{width:min(1150px,96vw)}

    /* HERO */
    .hero{
      position:relative; border-radius:28px; padding:28px 22px; margin-bottom:16px; overflow:hidden;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      backdrop-filter: blur(10px); box-shadow: var(--shadow);
    }
    .title{
      margin:0 0 6px; font-weight:1000; font-size:clamp(2rem,5.4vw,3.2rem); letter-spacing:.01em; line-height:1.1;
      display:flex; align-items:center; gap:14px; flex-wrap:wrap;
      background: linear-gradient(135deg,#fff,#cbd5e1 60%, #ffffff);
      -webkit-background-clip:text;background-clip:text;color:transparent;
      text-shadow: 0 8px 50px rgba(96,165,250,.18);
    }
    .title-badge{
      padding:6px 10px; border-radius:999px; font-weight:800; font-size:.9rem; color:#041106; border:none;
      background:linear-gradient(135deg, var(--accent) 0%, #16a34a 100%); box-shadow: 0 10px 32px rgba(34,197,94,.25);
    }
    .subtitle{ margin:6px 0 0; color:var(--muted); font-size:clamp(.95rem, 2.2vw, 1.05rem) }

    /* Tabs */
    .tabs{display:flex; gap:10px; margin:16px 0 18px; flex-wrap:wrap}
    .tab-btn{
      border:1px solid rgba(255,255,255,.18); background:#0b1220; color:var(--text);
      padding:10px 14px; border-radius:999px; cursor:pointer; font-weight:800;
      transition:border-color .2s ease, background .2s ease, transform .06s ease;
    }
    .tab-btn.active{
      background:linear-gradient(135deg, var(--accent-2) 0%, #2563eb 100%);
      border:none;color:#041106; box-shadow:0 10px 28px rgba(96,165,250,.28);
    }

    .card{
      background:linear-gradient(180deg,var(--card-a),var(--card-b));
      border:1px solid var(--border); border-radius:var(--radius);
      box-shadow:var(--shadow); backdrop-filter: blur(8px); padding:22px;
    }

    /* Grid */
    .grid{display:grid; gap:20px; grid-template-columns:repeat(12,1fr)}
    .span-12{grid-column:span 12}
    .span-6{grid-column:span 6}
    .span-4{grid-column:span 4}
    @media (max-width: 860px){ .span-6,.span-4{grid-column:span 12} }

    /* Music */
    .music{display:flex; align-items:center; gap:12px}
    .music button{
      border:none; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:800; color:#041106;
      background:linear-gradient(135deg, var(--accent) 0%, #16a34a 100%);
    }
    .music .label{color:var(--muted)}
     
    .yt-hidden-player {
      position: absolute; width: 1px; height: 1px;
      opacity: 0; pointer-events: none; left: -9999px;
    }

    /* Clock */
    .clock{display:flex;align-items:center;justify-content:space-between}
    .clock .time{font-size:clamp(1.6rem,4.2vw,2.4rem);font-weight:900;letter-spacing:.02em}
    .clock .time small{font-weight:700;opacity:.75;font-size:.6em;margin-left:6px}
    .clock .date{color:var(--muted)}
    @media (max-width: 430px){
      .clock .time{font-size:1.55rem}
    }

    /* Weather */
    .weather{display:grid;grid-template-columns:auto 1fr auto;gap:10px;align-items:center}
    .wx-icon{font-size:2.2rem;line-height:1}
    .wx-main{display:flex;flex-direction:column}
    .wx-place{font-weight:800}
    .wx-desc{color:var(--muted)}
    .wx-temp{font-size:1.8rem;font-weight:900}

    /* Section */
    h2.section{margin:0 0 8px;font-size:.95rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)}

    /* Quotes */
    blockquote{margin:10px 0 8px;font-size:clamp(1.2rem,2.5vw + .5rem,2rem);font-weight:900}
    blockquote::before, blockquote::after{content:"‚Äú"; color:var(--accent)}
    blockquote::after{content:"‚Äù"}
    .author{color:var(--muted);font-style:italic}
    .row{display:flex; flex-wrap:wrap; gap:12px; margin-top:16px}
    .btn, a.btn{
      border:1px solid rgba(255,255,255,.18); background:#0b1220; color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800; text-decoration:none;
      transition: transform .06s ease, border-color .2s ease, background .2s ease; user-select:none;
    }
    .primary{background:linear-gradient(135deg, var(--accent) 0%, #16a34a 100%); border:none; color:#041106}
    .secondary{background:linear-gradient(135deg, var(--accent-2) 0%, #2563eb 100%); border:none; color:#041106}
     
    /* üî¥ RED BUTTON CLASS */
    .danger{
      background:linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); 
      border:none; color:#ffffff; 
      box-shadow: 0 4px 14px rgba(239, 68, 68, 0.4);
    }
     
    .ghost{background:transparent}
    .muted{color:var(--muted)}
    .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,.2);border-top-color:var(--accent-2);border-radius:50%;display:inline-block;animation:spin .8s linear infinite;vertical-align:-2px;margin-right:6px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .fade-in{animation:fadeIn .7s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)} to{opacity:1;transform:translateY(0)}}

    /* Quote countdown chip */
    .count-wrap{position:relative}
    .countdown{
      position:absolute; top:-6px; right:-6px; width:46px; height:46px; border-radius:50%;
      background: radial-gradient(closest-side, rgba(15,23,42,0.92) 70%, transparent 71%),
                  conic-gradient(var(--accent) var(--progress,0%), var(--countdown-track) 0);
      display:grid; place-items:center; box-shadow:0 4px 16px rgba(0,0,0,.35); border:1px solid var(--border);
      font-size:.7rem; color:var(--muted); user-select:none;
    }
    .countdown span{font-variant-numeric:tabular-nums}

    /* Saved quotes */
    .saved-list{display:grid; gap:12px}
    .saved-item{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:14px;
    }
    .saved-meta{display:flex;justify-content:space-between;gap:8px;color:var(--muted);font-size:.9rem;margin-top:6px}
    .empty{color:var(--muted);text-align:center;padding:20px}

    /* Pomodoro */
    .pom-wrap{display:grid; gap:18px; grid-template-columns:repeat(12,1fr); align-items:start}
    .pom-main{grid-column: span 7; display:grid; justify-items:center}
    .pom-side{grid-column: span 5}
    @media (max-width: 980px){ .pom-main, .pom-side{grid-column: span 12} .pom-side{display:grid; justify-items:center} }

    .pom-timer.card{
      display:grid; gap:18px; place-items:center; text-align:center;
      width:100%; max-width:350px; margin-inline:auto; padding:18px;
    }
    .ring{
      --ring-size: 220px; /* smaller */
      position:relative; width:var(--ring-size); height:var(--ring-size); border-radius:50%;
      /* üî¥ THICKER RING (76% hole = 24% thick) */
      background:
        radial-gradient(closest-side, #151f32 76%, transparent 77%),
        conic-gradient(var(--accent) var(--pom-progress,0%), rgba(255,255,255,.18) 0);
      box-shadow: 0 20px 60px rgba(34,197,94,.15), 0 0 0 1px var(--border) inset;
      display:grid; place-items:center;
      margin-top: 16px;
    }
    /* FIX: Force text to be on top layer */
    .ring .time{ 
      font-size: clamp(1.9rem, 5.6vw, 2.7rem); 
      font-weight: 1000; 
      letter-spacing: .02em; 
      position: relative; 
      z-index: 5;
    }

    .mode-pill{
      padding:6px 10px; border-radius:999px; font-weight:900; font-size:.85rem; color:#041106;
      background:linear-gradient(135deg, var(--accent-2) 0%, #2563eb 100%);
    }
    
    /* POMODORO CONTROLS WITH CSS ACTIVE STATE FIX */
    .pom-controls{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .pom-controls .btn{
       font-weight:900; 
       transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), filter 0.1s ease;
    }
    /* This creates the visual feedback without breaking JavaScript */
    .pom-controls .btn:active {
       transform: scale(0.92);
       filter: brightness(1.3);
    }
    
    .preset-row{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
    .preset input{width:70px; border-radius:8px; background:#0b1220; border:1px solid var(--border); color:#fff; padding:6px 8px}
    .meta-row{display:flex; gap:16px; justify-content:center; color:var(--muted); font-size:.95rem; flex-wrap:wrap}

    .tasks .task-row{display:flex; gap:10px; align-items:center}
    .tasks input[type="text"]{flex:1; border-radius:10px; background:#0b1220; border:1px solid var(--border); color:#fff; padding:10px 12px}
    .tasks ul{list-style:none; margin:10px 0 0; padding:0; display:grid; gap:8px}
    .tasks li{
      display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--border);
      border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    .tasks li.done{opacity:.7; text-decoration: line-through}
    .tasks .small{font-size:.9rem; color:var(--muted)}

   /* iPhone compact Pomodoro */
@media (max-width: 430px){
  body{ font-size:15px; }
  .pom-timer.card{ max-width: 320px; padding:14px; gap:14px; }
  .ring{ --ring-size: 160px; margin-top: 10px; }
  .ring .time{ font-size: 1.6rem; letter-spacing:.01em; }
  .mode-pill{ font-size:.8rem; padding:5px 9px; }
  .btn{ padding:9px 12px; font-size:.95rem; border-radius:9px; }
  .pom-controls{ gap:8px; }
  .pom-controls .btn{ flex:1 1 calc(50% - 8px); min-width:128px; }
  .preset-row{ gap:8px; }
  .preset input{ width:60px; padding:5px 7px; }
  .meta-row{ gap:10px; font-size:.88rem; }
  .pom-side > .card{ width:100%; max-width:340px; }
}

@media (max-width: 375px){
  .pom-timer.card{ max-width: 300px; padding:12px; gap:12px; }
  .ring{ --ring-size: 140px; }
  .ring .time{ font-size: 1.4rem; }
  .pom-controls .btn{ min-width:120px; }
  .preset input{ width:56px; }
}

    /* Sticky Footer Toolbar */
    .toolbar{
      position:fixed;
      left:50%; transform:translateX(-50%);
      bottom:calc(16px + env(safe-area-inset-bottom, 0px));
      z-index:50;
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:center;
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid var(--border); border-radius:999px; padding:10px 12px;
      backdrop-filter: blur(10px); box-shadow: 0 16px 40px rgba(0,0,0,.35);
    }
    .tool-btn{
      display:flex; align-items:center; gap:8px; padding:10px 14px; border-radius:999px; text-decoration:none;
      color:var(--text); border:1px solid rgba(255,255,255,.18); background:#0b1220; font-weight:800;
      transition: border-color .2s ease, transform .06s ease;
    }
    @media (max-width: 480px){
      .toolbar{left:0; right:0; transform:none; margin:0 12px; justify-content:space-between}
      .tool-btn{flex:1 1 auto; justify-content:center; min-width:0}
    }

    /* FOCUS LAB STYLES */
    /* 1. Trataka Overlay */
    .focus-overlay{
      position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999;
      background:black; display:none; place-items:center; cursor:pointer;
      animation: fadeIn .4s ease;
    }
    .focus-center{
      position:relative; width:400px; height:400px; display:grid; place-items:center;
    }
    .focus-dot{
      width:16px; height:16px; background:white; border-radius:50%;
      box-shadow: 0 0 20px rgba(255,255,255,0.8);
      position:absolute; z-index:2;
    }
    .breathing-circle-anim{
      position:absolute; width:100px; height:100px;
      border:2px solid rgba(255,255,255,0.2); border-radius:50%;
      animation: breathe 8s infinite ease-in-out;
    }
    .breathing-circle-anim:nth-child(2) { animation-delay: 0.5s; width:140px; height:140px; border-color:rgba(255,255,255,0.15); }
    .breathing-circle-anim:nth-child(3) { animation-delay: 1s; width:180px; height:180px; border-color:rgba(255,255,255,0.1); }
    @keyframes breathe { 0%, 100% { transform: scale(0.8); opacity: 0.3; } 50% { transform: scale(1.5); opacity: 0.8; } }

    /* 2. Box Breathing */
    .breathing-circle {
      width: 140px; height: 140px; border-radius: 50%;
      background: radial-gradient(circle, var(--accent-2) 0%, rgba(96,165,250,0.1) 70%);
      margin: 20px auto;
      display: grid; place-items: center;
      font-weight: 900; color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.5);
      transition: all 4s ease-in-out;
      border: 4px solid var(--accent-2);
      box-shadow: 0 0 20px var(--accent-2);
    }
    .breathing-container { text-align: center; padding: 20px; }
    .b-inhale { transform: scale(1.5); background-color: var(--accent); border-color: var(--accent); box-shadow: 0 0 40px var(--accent); }
    .b-hold { transform: scale(1.5); border-style: dashed; }
    .b-exhale { transform: scale(1); background-color: var(--accent-2); }
    
    /* 3. Brain Dump */
    .brain-dump-area {
      width: 100%; height: 150px;
      background: rgba(0,0,0,0.3); border: 1px solid var(--border);
      color: var(--text); padding: 12px; border-radius: 12px;
      font-family: inherit; font-size: 1rem; resize: vertical;
    }
    
    /* 4. Zen Mode */
    #zen-overlay {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: #000; z-index: 9999;
      display: none; align-items: center; justify-content: center;
      flex-direction: column;
    }
    #zen-text { font-size: 3rem; font-weight: 900; color: var(--accent); text-align: center; padding: 20px; }
    #zen-exit { margin-top: 20px; opacity: 0.5; cursor: pointer; }
    #zen-exit:hover { opacity: 1; }

    /* Footer */
    .site-footer{
      margin-top: 28px;
      text-align: center;
      font-size: .9rem;
      color: var(--muted);
    }
    .site-footer a{ color: var(--accent-2); font-weight: 700; text-decoration: none; }
    .site-footer a:hover{ text-decoration: underline; }

    /* ===== Home: Focus Tasks Mini Circle (VISUAL FIX) ===== */
    .htasklist{
      display:grid;
      grid-template-columns: repeat( auto-fit, minmax(260px, 1fr) );
      gap:14px;
    }
    .htask-card{
      display:flex; align-items:center; gap:14px;
      padding:12px; border:1px solid var(--border); border-radius:12px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
    }
    /* Updated Mini Circle to match Dashboard Dark Look */
    .mini-circle{
      --size:86px; 
      width:var(--size); height:var(--size); border-radius:50%; flex:0 0 var(--size);
      /* Dark Grey Track + Green Progress (var(--accent)) */
      background:
        radial-gradient(closest-side, #1e293b 76%, transparent 77%),
        conic-gradient(var(--accent) var(--prog), #334155 0);
      display:grid; place-items:center; 
      border: 2px solid #334155; 
      box-shadow:0 10px 28px rgba(0,0,0,.25);
      font-weight:900; letter-spacing:.02em; font-variant-numeric: tabular-nums;
      font-size: 1.2rem;
      color: #fff;
    }
    .htask .meta{display:flex; flex-direction:column; gap:4px}
    .htask .name{font-weight:900; font-size:1.05rem}
    .htask .sub{color:var(--muted); font-size:.95rem}
    .done-list{display:grid; gap:10px; margin-top:12px}
    .done-item{display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02))}
    .pill{padding:4px 8px; border-radius:999px; background:rgba(255,255,255,.08); border:1px solid var(--border); color:var(--muted); font-size:.85rem}

    @media (max-width:430px){
      .mini-circle{ --size:78px; font-size:1.1rem; }
      .htask .name{ font-size:1rem; }
      .htask .sub{ font-size:.9rem; }
    }

    /* Simple tool cards extra (CENTERED TEXT FIX) */
    .tool-card {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      padding: 24px 16px;
    }
    .tool-card h3 { margin: 0 0 10px 0; }
    .tool-card p { margin: 0 0 16px 0; flex-grow: 1; display:flex; align-items:center; justify-content:center; }
    .tool-card a.btn, .tool-card button.btn {
      display: inline-block;
      width: 100%;
      margin-top: auto; /* Push to bottom if needed */
    }

  </style>
</head>
<body>
  
  <div id="focus-overlay" class="focus-overlay" title="Click anywhere to close">
     <div class="focus-center">
        <div class="focus-dot"></div>
        <div class="breathing-circle-anim"></div>
        <div class="breathing-circle-anim"></div>
        <div class="breathing-circle-anim"></div>
     </div>
     <div style="position:absolute; bottom:40px; color:#555; font-size:0.9rem;">Tap to exit</div>
  </div>

  <div id="zen-overlay">
      <div id="zen-text">Your Goal</div>
      <div id="zen-exit" class="btn ghost">Exit Zen Mode</div>
  </div>

  <div class="shell">
    <header class="hero">
      <div class="title">Homer <span id="greeting" class="title-badge">Hello</span></div>
      <div class="subtitle">‚ÄúTrying is the first step towards failure.‚Äù ‚Äî Homer Simpson</div>
    </header>

    <div class="tabs">
      <button class="tab-btn active" data-tab="home">Home</button>
      <button class="tab-btn" data-tab="saved">Saved Quotes</button>
      <button class="tab-btn" data-tab="pomodoro">Pomodoro</button>
      <button class="tab-btn" data-tab="focuslab">Focus Lab</button>
      <button class="tab-btn" data-tab="investing">Investing</button>
      <button class="tab-btn" data-tab="tools">Tools</button>
    </div>

    <section id="tab-home" class="tab card">
      <div class="grid">
        <div class="span-6 card">
          <h2 class="section">Clock</h2>
          <div class="clock">
            <div>
              <div class="time" id="clock-time">--:--<small>--</small></div>
              <div class="date" id="clock-date">Loading date‚Ä¶</div>
            </div>
            <div class="clock-icon">üïí</div>
          </div>
        </div>

        <div class="span-6 card">
          <h2 class="section">Weather</h2>
          <div class="weather">
            <div class="wx-icon" id="wx-icon">‚õÖ</div>
            <div class="wx-main">
              <div class="wx-place" id="wx-place">Locating‚Ä¶</div>
              <div class="wx-desc" id="wx-desc">‚Äî</div>
            </div>
            <div class="wx-temp" id="wx-temp">--¬∞</div>
          </div>
          <div class="muted" style="margin-top:10px;font-size:.85rem">Powered by open-mete–æ.com</div>
        </div>

        <div class="span-12 card count-wrap">
          <div class="countdown" id="countdown" title="Time until next quote">
            <span id="countdown-text">15m</span>
          </div>

          <h2 class="section">Daily Inspiration</h2>
          <p id="status" class="muted"><span class="spinner"></span>Fetching wisdom‚Ä¶</p>
          <blockquote id="quote" style="display:none;"></blockquote>
          <div id="byline" class="author" style="display:none;">‚Äî <span id="author"></span></div>

          <div class="row" aria-label="Actions">
            <button id="refresh" class="btn primary">New Quote</button>
            <button id="btn-humor" class="btn secondary">Humor</button>
            <button id="save" class="btn ghost">Save</button>
            <button id="copy" class="btn ghost">Copy</button>
          </div>
        </div>

        <div class="span-12 card" id="home-tasks-card" style="display:none">
          <h2 class="section">Focus Tasks</h2>
          <div class="htasklist" id="home-tasks"></div>
          <div class="muted" id="home-tasks-empty" style="display:none">No open tasks. Add one in Pomodoro ‚Üí Tasks.</div>
        </div>

        <div class="span-12 card" id="home-done-card" style="display:none">
          <h2 class="section">Recently Completed</h2>
          <div class="done-list" id="home-done-list"></div>
        </div>
      </div>
    </section>

    <section id="tab-saved" class="tab card" style="display:none">
      <h2 class="section">Saved Quotes</h2>
      <div class="row" style="margin-bottom:10px">
        <button id="exportSaved" class="btn">Export (.txt)</button>
        <button id="clearSaved" class="btn ghost">Clear All</button>
      </div>
      <div id="savedList" class="saved-list"></div>
      <div id="savedEmpty" class="empty" style="display:none">No saved quotes yet. Save your favorites from the Home tab.</div>
    </section>

    <section id="tab-pomodoro" class="tab card" style="display:none">
      <div class="pom-wrap">
        <div class="pom-main">
          <div class="pom-timer card">
            <div class="mode-pill" id="pom-mode">Focus</div>
            <div class="ring" id="pom-ring"><div class="time" id="pom-time">25:00</div></div>

            <div class="preset-row">
              <div class="preset"><label class="small muted">Focus</label><input id="set-focus" type="number" min="1" value="25"> min</div>
              <div class="preset"><label class="small muted">Short break</label><input id="set-short" type="number" min="1" value="5"> min</div>
              <div class="preset"><label class="small muted">Long break</label><input id="set-long" type="number" min="1" value="15"> min</div>
            </div>

            <div class="pom-controls">
              <button id="pom-start" class="btn primary">Start</button>
              <button id="pom-pause" class="btn ghost">Pause</button>
              <button id="pom-reset" class="btn ghost">Reset</button>
              <button id="pom-skip" class="btn secondary">Skip Phase</button>
            </div>

            <div class="meta-row">
              <div>Pomodoros: <strong id="pom-count">0</strong></div>
              <div>Cycle: <strong id="pom-cycle">1</strong>/4</div>
              <div><label><input type="checkbox" id="pom-notify"> Notifications</label></div>
              <div><label><input type="checkbox" id="pom-voice" checked> Voice lines (‚ÄúD‚Äôoh!‚Äù, ‚ÄúWoo-ho!‚Äù)</label></div>
              <div><label><input type="checkbox" id="pom-sfx" checked> Synth beeps</label></div>
            </div>
          </div>
        </div>

        <div class="pom-side">
          <div class="card tasks">
            <h2 class="section">Tasks</h2>
            <div class="task-row">
              <input id="task-input" type="text" placeholder="Add a task‚Ä¶">
              <button id="task-add" class="btn">Add</button>
            </div>
            <ul id="task-list"></ul>
            <div class="small" style="margin-top:8px">Tip: plan one task per focus session.</div>
          </div>

          <div class="card" style="margin-top:18px">
            <h2 class="section">Hints</h2>
            <div class="muted" style="font-size:.95rem">
              ‚Ä¢ 25/5 is classic: 25 min focus ‚Üí 5 min short break; every 4th break is long.<br>
              ‚Ä¢ Write a tiny task for each focus block to stay laser-focused.<br>
              ‚Ä¢ Enable notifications to get alerted on phase changes.<br>
              ‚Ä¢ Use ‚ÄúSkip Phase‚Äù if you finish early or need to switch.<br>
             <strong>Bonus:</strong>Keep everything in a single ‚Äútoday‚Äôs goal‚Äù list so you‚Äôre always working toward a tangible outcome. Happy ticking!
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="tab-focuslab" class="tab card" style="display:none">
       <div class="grid focus-grid-wrapper">
         
         <div class="span-6 card breathing-container">
           <h3 style="margin-top:0">üå¨Ô∏è Box Breathing</h3>
           <p class="muted small">Inhale (4s) ‚Ä¢ Hold (4s) ‚Ä¢ Exhale (4s) ‚Ä¢ Hold (4s)</p>
           <div id="b-circle" class="breathing-circle">Ready</div>
           <button id="b-toggle" class="btn primary">Start Breathing</button>
         </div>

         <div class="span-6 card" style="display:flex; flex-direction:column; gap:16px; justify-content:center;">
            <h3 style="margin-top:0">üî¨ Neuro Tools</h3>
            
            <button id="btn-focus-dot" class="btn primary" style="padding:16px;">
              üéØ Huberman Focus (Trataka)
              <div style="font-size:0.8em; opacity:0.8; font-weight:400; margin-top:4px;">Stare at the dot for 30s to spike focus.</div>
            </button>

            <div style="background:rgba(255,255,255,0.05); padding:16px; border-radius:12px; border:1px solid var(--border);">
               <h4 style="margin:0 0 8px;">üßò Zen Mode</h4>
               <input type="text" id="zen-input" placeholder="What is your ONE goal?" style="width:100%; padding:10px; border-radius:8px; background:#0b1220; border:1px solid var(--border); color:#fff; margin-bottom:10px;">
               <button id="zen-btn" class="btn secondary" style="width:100%">Enter Zen Mode</button>
            </div>
         </div>

         <div class="span-12 card">
           <h3 style="margin-top:0">üìù Brain Dump</h3>
           <p class="muted" style="font-size:0.9rem; margin-bottom:10px;">Distracting thought? Park it here. Auto-saved locally.</p>
           <textarea id="brain-dump" class="brain-dump-area" placeholder="I need to buy milk... Did I email Dave?..."></textarea>
           <div id="dump-status" class="muted" style="font-size:0.8rem; margin-top:6px; text-align:right;">Saved</div>
         </div>
       </div>
    </section>

    <section id="tab-investing" class="tab card" style="display:none">
      <h2 class="section">Market Intelligence</h2>
      <div class="grid">
        <div class="span-12 card" style="height: 650px; padding: 0; overflow: hidden; position: relative; background: #000;">
          <div id="tv_chart_container" style="width: 100%; height: 100%;"></div>
        </div>
        <div class="span-12 card">
          <h3 style="margin-top:0">üóûÔ∏è Market News (S&P 500)</h3>
          <div id="investing-news-list" class="saved-list">
             <p class="muted"><span class="spinner"></span> Parsing financial trends...</p>
          </div>
        </div>
      </div>
    </section>

 <section id="tab-tools" class="tab card" style="display:none">
  <h2 class="section">My Tools</h2>

  <div class="tools-wrap" style="max-width:860px;margin-inline:auto;">
    <div class="grid">
      <div class="span-4 card tool-card">
        <h3>üß© Nextcloud</h3>
        <p class="muted">Access your personal cloud and files securely.</p>
        <a href="https://cloud.b4it.ro" target="_blank" rel="noopener" class="btn primary">Open Nextcloud</a>
      </div>

      <div class="span-4 card tool-card">
        <h3>üìö Docs</h3>
        <p class="muted">Access personal documentation.</p>
        <a href="https://docs.b4it.ro/" target="_blank" rel="noopener" class="btn secondary">Open Notifications</a>
      </div>

      <div class="span-4 card tool-card">
        <h3>‚è∞ Reminders</h3>
        <p class="muted">Manage your reminders and schedule tasks.</p>
        <a href="https://reminder.b4it.ro/reminders" target="_blank" rel="noopener" class="btn primary">Open Reminders</a>
      </div>

      <div class="span-4 card tool-card">
        <h3>üìî Journal</h3>
        <p class="muted">Daily notes and reflections.</p>
        <a href="https://journal.b4it.ro" target="_blank" rel="noopener" class="btn primary">Open Journal</a>
      </div>
       
      <div class="span-4 card tool-card">
        <h3>üçø Jellyfin</h3>
        <p class="muted">Your personal media server.</p>
        <a href="https://jellyfin.b4it.ro" target="_blank" rel="noopener" class="btn primary">Open Jellyfin</a>
      </div>

      <div class="span-4 card tool-card">
        <h3>üóíÔ∏è Notes</h3>
        <p class="muted">Quick notes & to-dos.</p>
        <a href="https://tasks.b4it.ro" target="_blank" rel="noopener" class="btn primary">Open Notes</a>
      </div>

      <div class="span-4 card tool-card">
        <h3>‚ú® Gemini</h3>
        <p class="muted">Google's AI assistant.</p>
        <a href="https://gemini.google.com" target="_blank" rel="noopener" class="btn primary">Open Gemini</a>
      </div>

      <div class="span-4 card tool-card">
        <h3>üñºÔ∏è Immich</h3>
        <p class="muted">Self-hosted photos.</p>
        <a href="https://immich.b4it.ro" target="_blank" rel="noopener" class="btn primary">Open Immich</a>
      </div>
       
      <div class="span-4 card tool-card">
        <h3>‚òï Keep Awake</h3>
        <p class="muted">Prevents screen from sleeping.</p>
        <button id="btn-wake" class="btn danger">‚òï Keep Awake</button>
      </div>

    </div>
  </div>

 <div class="card ambient-section" style="margin-top:28px; text-align:center; padding:24px; max-width:860px; margin-inline:auto;">
  <h2 class="section" style="margin-bottom:16px;">üéß Ambient Sounds</h2>

  <div style="
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap:16px;
    justify-items:stretch;
  ">
    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üåä Ocean</h3>
      <button id="btn-ocean" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Ocean</button>
      <input id="vol-ocean" type="range" min="0" max="100" value="50" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üî• Fireplace</h3>
      <button id="btn-fire" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Fireplace</button>
      <input id="vol-fire" type="range" min="0" max="100" value="40" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üåßÔ∏è Rain</h3>
      <button id="btn-rain" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Rain</button>
      <input id="vol-rain" type="range" min="0" max="100" value="60" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üåßÔ∏èü™ü Jazz</h3>
      <button id="btn-rainywindow" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Jazz</button>
      <input id="vol-rainywindow" type="range" min="0" max="100" value="60" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">‚òï Caf√©</h3>
      <button id="btn-cafe" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Caf√©</button>
      <input id="vol-cafe" type="range" min="0" max="100" value="50" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üé∂ Lo-Fi Chill Beats</h3>
      <button id="btn-lofi" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Lo-Fi</button>
      <input id="vol-lofi" type="range" min="0" max="100" value="50" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üçÉ Wind</h3>
      <button id="btn-wind" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Wind</button>
      <input id="vol-wind" type="range" min="0" max="100" value="50" style="width:100%;">
    </div>

    <div class="card" style="padding:16px; text-align:left;">
      <h3 style="margin:0 0 10px;">üìö Synthwave mix</h3>
      <button id="btn-synthwave" class="btn primary" style="width:100%; margin-bottom:8px; padding:8px 12px; font-size:.95rem;">‚ñ∂Ô∏è Play Synthwave</button>
      <input id="vol-synthwave" type="range" min="0" max="100" value="50" style="width:100%;">
    </div>
  </div> <div class="ambient-section" style="margin-top:24px; display:flex; flex-wrap:wrap; justify-content:center; gap:12px;">
    <button id="mix-sleep" class="btn secondary" style="padding:8px 14px; font-size:.95rem;">üåô Sleep Mix</button>
    <button id="mix-rainy" class="btn secondary" style="padding:8px 14px; font-size:.95rem;">üå¶Ô∏è Rainy Mix</button>
    <button id="mix-reading" class="btn secondary" style="padding:8px 14px; font-size:.95rem;">üìñ Reading Mix</button>
    <button id="mix-cozy" class="btn secondary" style="padding:8px 14px; font-size:.95rem;">üìñ Cozy Night in</button>
    <button id="stop-all" class="btn ghost" style="padding:8px 14px; font-size:.95rem;">‚èπ Stop All</button>
  </div>

  <div id="yt-ocean" class="yt-hidden-player"></div>
  <div id="yt-fire" class="yt-hidden-player"></div>
  <div id="yt-rain" class="yt-hidden-player"></div>
  <div id="yt-rainywindow" class="yt-hidden-player"></div>
  <div id="yt-cafe" class="yt-hidden-player"></div>
  <div id="yt-lofi" class="yt-hidden-player"></div>
  <div id="yt-wind" class="yt-hidden-player"></div>
  <div id="yt-synthwave" class="yt-hidden-player"></div>
  <div id="yt-weightless" class="yt-hidden-player"></div>
</div>

</section>
    <footer class="site-footer">
      Created with ‚ù§Ô∏è by <a href="https://github.com/tathagata1428/" target="_blank" rel="noopener">Bogdan Radu</a>
      <span style="font-size:0.7em; opacity:0.4; margin-left:6px;">v5.7 (Visual Polish)</span>
    </footer>
  </div>

  <nav class="toolbar" aria-label="Quick links">
    <a class="tool-btn" href="https://www.youtube.com/" target="_blank" rel="noopener">‚ñ∂Ô∏è YouTube</a>
    <a class="tool-btn" href="https://gemini.google.com" target="_blank" rel="noopener">‚ú® Gemini AI</a>
    <a class="tool-btn" href="https://tasks.b4it.ro" target="_blank" rel="noopener">üóíÔ∏è Notes</a>
    <a class="tool-btn" href="https://www.google.com" target="_blank" rel="noopener">üîé Google</a>
  </nav>

  <script>
    /* 1. TABS */
    const tabBtns = [...document.querySelectorAll('.tab-btn')];
    const tabs = {
      home: document.getElementById('tab-home'),
      saved: document.getElementById('tab-saved'),
      pomodoro: document.getElementById('tab-pomodoro'),
      focuslab: document.getElementById('tab-focuslab'),
      investing: document.getElementById('tab-investing'), // ADDED INVESTING TAB HERE
      tools: document.getElementById('tab-tools')
    };
    function showTab(name) {
      Object.entries(tabs).forEach(([k, el]) => {
        if(el) el.style.display = (k === name) ? 'block' : 'none';
      });
      tabBtns.forEach(b => b.classList.toggle('active', b.dataset.tab === name));
      
      // FIXED: Only initialize the chart AFTER the display is set to block
      if(name === 'investing') {
        setTimeout(initInvestingTab, 50);
      }
    }
    tabBtns.forEach(b => b.addEventListener('click', () => showTab(b.dataset.tab)));

    /* 2. CLOCK */
    function updateClock(){
      const now=new Date();
      const hh=now.getHours().toString().padStart(2,'0');
      const mm=now.getMinutes().toString().padStart(2,'0');
      const ss=now.getSeconds().toString().padStart(2,'0');
      const day=new Intl.DateTimeFormat(undefined,{weekday:'long'}).format(now);
      const date=new Intl.DateTimeFormat(undefined,{day:'2-digit',month:'long',year:'numeric'}).format(now);
      document.getElementById('clock-time').innerHTML=`${hh}:${mm}<small>${ss}</small>`;
      document.getElementById('clock-date').textContent=`${day}, ${date}`;

      const hVal = now.getHours();
      let greet = "Hello";
      if(hVal < 12) greet = "Good Morning";
      else if(hVal < 18) greet = "Good Afternoon";
      else greet = "Good Evening";
      const gEl = document.getElementById('greeting');
      if(gEl) gEl.textContent = greet;
    }
    updateClock(); setInterval(updateClock,1000);

    /* 3. WEATHER */
    const WX_CODES={0:["‚òÄÔ∏è","Clear sky"],1:["üå§Ô∏è","Mainly clear"],2:["‚õÖ","Partly cloudy"],3:["‚òÅÔ∏è","Overcast"],45:["üå´Ô∏è","Fog"],48:["üå´Ô∏è","Rime fog"],51:["üå¶Ô∏è","Light drizzle"],53:["üå¶Ô∏è","Drizzle"],55:["üåßÔ∏è","Dense drizzle"],56:["üåßÔ∏è","Freezing drizzle"],57:["üåßÔ∏è","Freezing drizzle"],61:["üå¶Ô∏è","Light rain"],63:["üåßÔ∏è","Rain"],65:["üåßÔ∏è","Heavy rain"],66:["üåßÔ∏è","Freezing rain"],67:["üåßÔ∏è","Freezing rain"],71:["üå®Ô∏è","Light snow"],73:["üå®Ô∏è","Snow"],75:["‚ùÑÔ∏è","Heavy snow"],77:["‚ùÑÔ∏è","Snow grains"],80:["üå¶Ô∏è","Rain showers"],81:["üåßÔ∏è","Rain showers"],82:["‚õàÔ∏è","Violent rain"],85:["üå®Ô∏è","Snow showers"],86:["‚ùÑÔ∏è","Heavy snow showers"],95:["‚õàÔ∏è","Thunderstorm"],96:["‚õàÔ∏è","Thunder + hail"],99:["‚õàÔ∏è","Severe thunder/hail"]};
    async function loadWeather(lat,lon,label){
      const url=`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`;
      const res=await fetch(url,{cache:'no-store'}); const data=await res.json(); const cw=data.current_weather;
      const [icon,desc]=WX_CODES[cw.weathercode]||["‚õÖ","Weather"];
      document.getElementById('wx-icon').textContent=icon;
      document.getElementById('wx-place').textContent=label||"Your location";
      document.getElementById('wx-desc').textContent=`${desc} ‚Ä¢ Wind ${Math.round(cw.windspeed)} km/h`;
      document.getElementById('wx-temp').textContent=`${Math.round(cw.temperature)}¬∞`;
    }
    function detectWeather(){
      const fallback={lat:44.4268,lon:26.1025,label:"Bucharest"};
      if(!('geolocation'in navigator)) return loadWeather(fallback.lat,fallback.lon,fallback.label);
      navigator.geolocation.getCurrentPosition(
        pos=>loadWeather(pos.coords.latitude,pos.coords.longitude,"Your location"),
        _=>loadWeather(fallback.lat,fallback.lon,fallback.label),
        {enableHighAccuracy:false,timeout:8000,maximumAge:600000}
      );
    }
    detectWeather();

    /* 4. QUOTES (Hybrid Static Logic) */
    const AUTO_MS = 900_000; // 15 min
    const DB_URL = "https://raw.githubusercontent.com/JamesFT/Database-Quotes-JSON/master/quotes.json";
    let globalQuotes = null;
    const TOPICS = ["wisdom", "success", "courage", "happiness", "time", "freedom", "philosophy"];
    
    const BACKUP_MOTIVATION = [
      {quoteText:"Success is not final, failure is not fatal: it is the courage to continue that counts.", quoteAuthor:"Winston Churchill"},
      {quoteText:"Life is simple. Are you happy? Yes? Keep going. No? Change something.", quoteAuthor:"Bogdan Radu"},
      {quoteText:"The only way to do great work is to love what you do.", quoteAuthor:"Steve Jobs"}
    ];
    const BACKUP_HUMOR = [
      {content: "I am so clever that sometimes I don't understand a single word of what I am saying.", author: "Oscar Wilde"},
      {content: "Behind every great man is a woman rolling her eyes.", author: "Jim Carrey"}
    ];

    const els = {
      quote:document.getElementById("quote"),
      author:document.getElementById("author"),
      byline:document.getElementById("byline"),
      status:document.getElementById("status"),
      refresh:document.getElementById("refresh"),
      save:document.getElementById("save"),
      copy:document.getElementById("copy"),
      countdown:document.getElementById("countdown"),
      countdownText:document.getElementById("countdown-text"),
      savedList:document.getElementById("savedList"),
      savedEmpty:document.getElementById("savedEmpty"),
      exportSaved:document.getElementById("exportSaved"),
      clearSaved:document.getElementById("clearSaved"),
    };

    function setLoading(show){ els.status.style.display=show?"block":"none"; els.quote.style.display=show?"none":"block"; els.byline.style.display=show?"none":"block"; }
    function fadeIn(){ els.quote.classList.remove('fade-in'); els.byline.classList.remove('fade-in'); void els.quote.offsetWidth; els.quote.classList.add('fade-in'); els.byline.classList.add('fade-in'); }
    function renderQuote(q){
      const txt=q.content||q.quoteText||"Stay motivated."; 
      const ath=q.author||q.quoteAuthor||"Unknown";
      els.quote.textContent=txt; els.author.textContent=ath;
      setLoading(false); fadeIn(); resetCountdown();
    }
    
    /* --- API LOGIC (SMART LOCAL PROXY + HTML TRAP) --- */
    const IS_LOCAL = window.location.protocol === 'file:' || window.location.hostname === 'localhost';
    const API_HUMOR = "https://official-joke-api.appspot.com/random_joke";

    async function fetchMotivation() {
      try {
        const url = IS_LOCAL 
          ? "https://api.codetabs.com/v1/proxy?quest=" + encodeURIComponent(DB_URL)
          : DB_URL;

        if (!globalQuotes) {
           const r = await fetch(url);
           const text = await r.text();
           if(text.trim().startsWith("<")) throw new Error("Received HTML instead of JSON");
           globalQuotes = JSON.parse(text);
        }
        const topic = TOPICS[Math.floor(Math.random() * TOPICS.length)];
        const candidates = globalQuotes.filter(q => q.quoteText.toLowerCase().includes(topic));
        const pool = candidates.length > 0 ? candidates : globalQuotes;
        return pool[Math.floor(Math.random() * pool.length)];
      } catch (e) {
        return BACKUP_MOTIVATION[Math.floor(Math.random() * BACKUP_MOTIVATION.length)];
      }
    }

    async function fetchHumor() {
      try {
        const r = await fetch(API_HUMOR);
        if (!r.ok) throw new Error("Humor API Failed");
        const data = await r.json();
        if(data.setup && data.punchline) return { content: `${data.setup} ... ${data.punchline}`, author: "Daily Joke" };
        throw new Error("Invalid");
      } catch (e) {
        return BACKUP_HUMOR[Math.floor(Math.random() * BACKUP_HUMOR.length)];
      }
    }

    els.refresh.addEventListener("click", async () => {
      setLoading(true);
      const statusText = document.querySelector("#status");
      if(statusText) statusText.innerHTML = '<span class="spinner"></span>Accessing library...';
      const q = await fetchMotivation();
      renderQuote(q);
    });

    const btnHumor = document.getElementById("btn-humor");
    if(btnHumor) {
      btnHumor.addEventListener("click", async () => {
        setLoading(true);
        const statusText = document.querySelector("#status");
        if(statusText) statusText.innerHTML = '<span class="spinner"></span>Fetching a laugh‚Ä¶';
        const q = await fetchHumor();
        renderQuote(q);
      });
    }

    let deadline = Date.now()+AUTO_MS, cdTimer=null;
    function resetCountdown(){ deadline = Date.now()+AUTO_MS; tickCountdown(); }
    function tickCountdown(){
      if(cdTimer) clearTimeout(cdTimer);
      const now=Date.now();
      let rem=Math.max(0, deadline-now);
      const mins=Math.floor(rem/60000);
      const secs=Math.floor((rem%60000)/1000);
      els.countdownText.textContent = mins>0 ? `${mins}m` : `${secs}s`;
      const pct = 100 - Math.round((rem/AUTO_MS)*100);
      els.countdown.style.setProperty('--progress', pct + '%');
      if(rem<=0){ els.refresh.click(); } else{ cdTimer=setTimeout(tickCountdown, 1000); }
    }

    els.copy.addEventListener("click",()=>{
      const txt=`"${els.quote.textContent}" ‚Äî ${els.author.textContent}`;
      navigator.clipboard.writeText(txt);
      const p=els.copy.textContent; els.copy.textContent="Copied!"; setTimeout(()=>els.copy.textContent=p,1500);
    });

    const SAVED_KEY="motivator.savedQuotes.v1";
    function loadSaved(){ try{ return JSON.parse(localStorage.getItem(SAVED_KEY)||"[]"); }catch{return [];} }
    function saveSaved(list){ localStorage.setItem(SAVED_KEY,JSON.stringify(list)); }
    function addCurrentToSaved(){
      const q=els.quote.textContent.trim(), a=els.author.textContent.trim(); if(!q) return;
      const list=loadSaved();
      if(!list.some(it=>it.q===q && it.a===a)){
        list.unshift({q,a,ts:Date.now()}); saveSaved(list); renderSaved();
        const prev=els.save.textContent; els.save.textContent="Saved ‚úì"; setTimeout(()=>els.save.textContent=prev,1100);
      }
    }
    function deleteSaved(idx){ const list=loadSaved(); list.splice(idx,1); saveSaved(list); renderSaved(); }
    function clearAllSaved(){ saveSaved([]); renderSaved(); }
    function renderSaved(){
      const list=loadSaved(); const empty=(list.length===0);
      els.savedList.innerHTML=""; els.savedEmpty.style.display=empty?"block":"none";
      list.forEach((it,idx)=>{
        const wrap=document.createElement('div'); wrap.className="saved-item";
        wrap.innerHTML=`<div><strong>‚Äú${it.q}‚Äù</strong></div>
          <div class="saved-meta"><span>‚Äî ${it.a||"Unknown"}</span><span>${new Date(it.ts).toLocaleString()}</span></div>
          <div class="row" style="margin-top:10px"><button class="btn ghost" data-act="copy" data-i="${idx}">Copy</button><button class="btn" data-act="del" data-i="${idx}">Delete</button></div>`;
        els.savedList.appendChild(wrap);
      });
    }
   els.savedList?.addEventListener('click', e => {
      const btn = e.target.closest('button'); 
      if(!btn) return;
      
      const idx = +btn.dataset.i; 
      
      // Handle Delete
      if(btn.dataset.act === 'del') { 
        deleteSaved(idx); 
      }
      
      // Handle Copy
      if(btn.dataset.act === 'copy') { 
        const list = loadSaved(); 
        const textToCopy = `‚Äú${list[idx].q}‚Äù ‚Äî ${list[idx].a || "Unknown"}`;
        
        // 1. Try modern clipboard API (using .then instead of async/await to preserve user gesture)
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showCopiedFeedback(btn);
            }).catch(() => {
                fallbackCopy(textToCopy, btn);
            });
        } else {
            fallbackCopy(textToCopy, btn);
        }
      }
    });

    // Helper for visual feedback
    function showCopiedFeedback(btn) {
        const originalText = btn.textContent;
        btn.textContent = "Copied ‚úì";
        btn.style.color = "var(--accent)"; // Green text
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.color = "";
        }, 1500);
    }

    // Helper for old-school fallback copy
    function fallbackCopy(text, btn) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed"; // Avoid scrolling to bottom
        textArea.style.opacity = "0";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            showCopiedFeedback(btn);
        } catch (err) {
            console.error("Fallback copy failed", err);
        }
        document.body.removeChild(textArea);
    }
    els.exportSaved?.addEventListener('click',()=>{
      const list=loadSaved(); const text=list.map(it=>`‚Äú${it.q}‚Äù ‚Äî ${it.a||"Unknown"}`).join("\n\n");
      const blob=new Blob([text],{type:'text/plain'}); const url=URL.createObjectURL(blob);
      const a=document.createElement('a'); a.href=url; a.download='saved-quotes.txt'; a.click(); URL.revokeObjectURL(url);
    });
    els.clearSaved?.addEventListener('click',clearAllSaved); els.save.addEventListener("click",addCurrentToSaved);
    els.refresh.click(); renderSaved();

    /* 5. FOCUS LAB LOGIC */
    
    // Focus Dot (Trataka) Logic - FIXED
    const btnFocusDot = document.getElementById("btn-focus-dot");
    const focusOverlay = document.getElementById("focus-overlay");
    
    if(btnFocusDot && focusOverlay) {
      btnFocusDot.addEventListener("click", () => {
        focusOverlay.style.display = "grid";
        // Try fullscreen
        if(document.documentElement.requestFullscreen) {
            document.documentElement.requestFullscreen().catch(e => console.log(e));
        }
      });
      
      focusOverlay.addEventListener("click", () => {
        focusOverlay.style.display = "none";
        // Exit fullscreen
        if(document.exitFullscreen) {
            document.exitFullscreen().catch(e => console.log(e));
        }
      });
    }

    // Zen Mode Logic - FIXED
    const zenBtn = document.getElementById("zen-btn");
    const zenExit = document.getElementById("zen-exit");
    const zenOverlay = document.getElementById("zen-overlay");
    const zenInput = document.getElementById("zen-input");
    const zenText = document.getElementById("zen-text");

    if(zenBtn && zenOverlay) {
        zenBtn.addEventListener("click", () => {
            const goal = zenInput.value.trim() || "FOCUS";
            zenText.textContent = goal;
            
            // Add class to body to hide everything else via CSS
            document.body.classList.add("zen-active");
            
            // Show overlay
            zenOverlay.style.display = "flex";
            
            // Fullscreen
            if(document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen().catch(e => console.log(e));
            }
        });

        zenExit.addEventListener("click", () => {
            // Remove class to restore everything
            document.body.classList.remove("zen-active");
            
            // Hide overlay
            zenOverlay.style.display = "none";
            
            // Exit fullscreen
            if(document.exitFullscreen) {
                document.exitFullscreen().catch(e => console.log(e));
            }
        });
    }

    // Brain Dump
    const txtDump = document.getElementById("brain-dump");
    const dumpStatus = document.getElementById("dump-status");
    if(txtDump) {
        txtDump.value = localStorage.getItem("homer-brain-dump") || "";
        txtDump.addEventListener("input", () => {
            localStorage.setItem("homer-brain-dump", txtDump.value);
            dumpStatus.textContent = "Saving...";
            setTimeout(() => dumpStatus.textContent = "Saved", 1000);
        });
    }
    // Box Breathing
    const btnBox = document.getElementById("b-toggle");
    const boxCircle = document.getElementById("b-circle");
    let bInterval = null, bStep = 0;
    if(btnBox && boxCircle) {
        btnBox.addEventListener("click", () => {
            if(bInterval) {
                clearInterval(bInterval); bInterval = null;
                btnBox.textContent = "Start Breathing";
                boxCircle.className = "breathing-circle";
                boxCircle.textContent = "Ready";
            } else {
                btnBox.textContent = "Stop";
                bStep = 0;
                const cycle = () => {
                    boxCircle.className = "breathing-circle";
                    if(bStep===0) { boxCircle.classList.add('b-inhale'); boxCircle.textContent="Inhale"; }
                    if(bStep===1) { boxCircle.classList.add('b-hold'); boxCircle.textContent="Hold"; }
                    if(bStep===2) { boxCircle.classList.add('b-exhale'); boxCircle.textContent="Exhale"; }
                    if(bStep===3) { boxCircle.classList.add('b-hold'); boxCircle.textContent="Hold"; }
                    bStep = (bStep + 1) % 4;
                };
                cycle();
                bInterval = setInterval(cycle, 4000);
            }
        });
    }
  </script>

  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const PKEY='pom.settings.v1', TKEY='pom.tasks.v1', SKEY='pom.state.v1';
      const elTime=document.getElementById('pom-time');
      const elRing=document.getElementById('pom-ring');
      const elMode=document.getElementById('pom-mode');
      const elCount=document.getElementById('pom-count');
      const elCycle=document.getElementById('pom-cycle');
      const elNotify=document.getElementById('pom-notify');
      const elVoice=document.getElementById('pom-voice');
      const elSfx=document.getElementById('pom-sfx');
      const elSetFocus=document.getElementById('set-focus');
      const elSetShort=document.getElementById('set-short');
      const elSetLong=document.getElementById('set-long');

      const btnStart=document.getElementById('pom-start');
      const btnPause=document.getElementById('pom-pause');
      const btnReset=document.getElementById('pom-reset');
      const btnSkip=document.getElementById('pom-skip');

      function loadJSON(k,def){ try{ return JSON.parse(localStorage.getItem(k)||JSON.stringify(def)); }catch{return def;} }
      function saveJSON(k,v){ localStorage.setItem(k,JSON.stringify(v)); }

      const settings=loadJSON(PKEY,{focus:25, short:5, long:15, longEvery:4});
      const state=loadJSON(SKEY,{mode:'focus', remaining:settings.focus*60, running:false, pomodoros:0});
      elSetFocus.value=settings.focus; elSetShort.value=settings.short; elSetLong.value=settings.long;
      elMode.textContent=cap(state.mode); updateTime(); updateRing(); updateMeta();

      function cap(s){ return s.charAt(0).toUpperCase()+s.slice(1); }
      function durFor(mode){ return (mode==='focus'?settings.focus:mode==='short'?settings.short:settings.long)*60; }
      function setMode(next){ state.mode=next; state.remaining=durFor(next); elMode.textContent=cap(next); updateTime(); updateRing(); save(); }
      function updateTime(){ const m=Math.floor(state.remaining/60).toString().padStart(2,'0'); const s=Math.floor(state.remaining%60).toString().padStart(2,'0'); elTime.textContent=`${m}:${s}`; }
      function updateRing(){ const total=durFor(state.mode); const progress=1-(state.remaining/total); const deg=Math.max(0,Math.min(360,progress*360)); elRing.style.setProperty('--pom-progress',`${deg}deg`); }
      // FIX: Cycle math correctly computes "1/4" when pomodoros is 0
      function updateMeta(){ elCount.textContent=state.pomodoros; elCycle.textContent=(state.pomodoros % settings.longEvery) + 1; }
      function save(){ saveJSON(SKEY,state); }

      let ac;
      function ensureAC(){ if(!ac){ ac = new (window.AudioContext||window.webkitAudioContext)(); } if(ac.state==='suspended'){ ac.resume(); } }
      function speak(text){ if(!elVoice?.checked) return; if(!('speechSynthesis' in window)) return; const u=new SpeechSynthesisUtterance(text); u.rate=1.05; u.pitch=text.includes('Woo')?1.3:0.8; window.speechSynthesis.cancel(); window.speechSynthesis.speak(u); }
      function tone(freq,dur,type='triangle',vol=0.22,when=0){ if(!elSfx?.checked) return; ensureAC(); const t=ac.currentTime+when; const o=ac.createOscillator(); const g=ac.createGain(); o.type=type; o.frequency.setValueAtTime(freq,t); g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(vol,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+dur); o.connect(g).connect(ac.destination); o.start(t); o.stop(t+dur+0.02); }
      function sfxWooHoo(){ speak("Woo-hoo!"); tone(880,0.12,'triangle',0.25,0); tone(1046.5,0.12,'triangle',0.22,0.10); tone(1318.5,0.18,'triangle',0.22,0.22); }
      function sfxDoh(){ speak("D‚Äôoh!"); tone(196,0.18,'sawtooth',0.25,0); tone(147,0.18,'sawtooth',0.20,0.10); }

      ['click','keydown','touchstart'].forEach(evt=>{
        window.addEventListener(evt,()=>{ try{ ensureAC(); if('speechSynthesis' in window) speechSynthesis.resume(); }catch(_){ } },{once:true, passive:true});
      });

      let tick=null;
      function start(){ if(state.running) return; state.running=true; save(); if(elNotify?.checked && 'Notification' in window && Notification.permission!=='granted'){ Notification.requestPermission(); } ensureAC(); tick=setInterval(()=>{ state.remaining--; if(state.remaining<=0){ advance(false); } updateTime(); updateRing(); save(); window.dispatchEvent(new Event('pom-tick')); },1000); }
      function pause(){ state.running=false; clearInterval(tick); save(); window.dispatchEvent(new Event('pom-tick')); }
      function skip(){ pause(); advance(true); } 
      function reset(){ 
          pause(); 
          state.pomodoros = 0; 
          setMode('focus'); 
          updateMeta(); 
          updateTime(); 
          updateRing(); 
          save();
          window.dispatchEvent(new Event('pom-tick'));
      }

      function advance(isSkip = false){
        if(state.mode==='focus'){
          state.pomodoros++;
          const n=state.pomodoros % settings.longEvery;
          setMode(n===0?'long':'short');
          
          if(!isSkip) {
            notify('Break time', n===0?`Long break (${settings.long}m)`:`Short break (${settings.short}m)`);
            sfxWooHoo();
          }
        }else{
          setMode('focus');
          if(!isSkip) {
            notify('Focus time', `${settings.focus} minutes ‚Äî go!`);
            sfxDoh();
          }
        }
        updateMeta(); save(); if(state.running) start();
      }
      function notify(title,body){
        if(!elNotify?.checked) return;
        if('Notification' in window && Notification.permission==='granted'){
          const n=new Notification(title,{body}); setTimeout(()=>n.close(),4000);
        }
      }

      // Safe JS Event listeners that rely on CSS for the visual pop
      btnStart.addEventListener('click',start);
      btnPause.addEventListener('click',pause);
      btnReset.addEventListener('click',reset);
      btnSkip.addEventListener('click',skip);

      [elSetFocus, elSetShort, elSetLong].forEach(inp=>{
        inp.addEventListener('change',()=>{
          settings.focus=Math.max(1,parseInt(elSetFocus.value||25));
          settings.short=Math.max(1,parseInt(elSetShort.value||5));
          settings.long=Math.max(1,parseInt(elSetLong.value||15));
          saveJSON(PKEY,settings);
          if(!state.running){ state.remaining=durFor(state.mode); updateTime(); updateRing(); save(); }
        });
      });

      /* Tasks */
      const taskInput=document.getElementById('task-input');
      const taskAdd=document.getElementById('task-add');
      const taskList=document.getElementById('task-list');
      function loadTasks(){ return loadJSON(TKEY,[]); }
      function saveTasks(list){ saveJSON(TKEY,list); }
      function renderTasks(){
        const list=loadTasks();
        taskList.innerHTML='';
        list.forEach((t,i)=>{
          const li=document.createElement('li');
          li.className = t.done?'done':'';
          li.innerHTML= `<input type="checkbox" data-i="${i}" ${t.done?'checked':''}>
            <span style="flex:1">${t.text}</span>
            <button class="btn ghost" data-act="del" data-i="${i}">Delete</button>`;
          taskList.appendChild(li);
        });
        window.dispatchEvent(new Event('tasks-changed'));
      }
      function addTask(){
        const text=taskInput.value.trim(); if(!text) return;
        const list=loadTasks(); list.unshift({text,done:false,ts:Date.now()});
        saveTasks(list); taskInput.value=''; renderTasks();
      }
      taskAdd.addEventListener('click',addTask);
      taskInput.addEventListener('keydown',e=>{ if(e.key==='Enter') addTask(); });
      taskList.addEventListener('click',e=>{
        const i=e.target.dataset.i; if(i==null) return;
        const list=loadTasks();
        if(e.target.matches('input[type="checkbox"]')){ list[i].done=e.target.checked; list[i].ts=Date.now(); }
        if(e.target.dataset.act==='del'){ list.splice(i,1); }
        saveTasks(list); renderTasks();
      });

      if(state.running){ start(); }
      renderTasks();
    });
  </script>

  <script>
    function fmtMMSS(totalSeconds){ const s=Math.max(0,Math.floor(totalSeconds)); const m=Math.floor(s/60).toString().padStart(2,'0'); const ss=(s%60).toString().padStart(2,'0'); return `${m}:${ss}`; }
    const LS='pom.state.v1', LS_SETTINGS='pom.settings.v1', LS_TASKS='pom.tasks.v1';
    function ls(k,def){ try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(def));}catch{return def;} }
    function getOpenTasks(){ const tasks=ls(LS_TASKS,[]); return tasks.filter(t=>!t.done); }
    function getDoneTop3(){ const tasks=ls(LS_TASKS,[]); return tasks.filter(t=>t.done).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,3); }

    function renderHomeFromPom(){
      const state=ls(LS, null);
      const settings=ls(LS_SETTINGS,{focus:25, short:5, long:15});
      const openTasks=getOpenTasks();
      const done=getDoneTop3();

      const tasksCard=document.getElementById('home-tasks-card');
      const tasksWrap=document.getElementById('home-tasks');
      const tasksEmpty=document.getElementById('home-tasks-empty');
      const doneCard=document.getElementById('home-done-card');
      const doneList=document.getElementById('home-done-list');

      tasksWrap.innerHTML='';
      if(openTasks.length===0){
        tasksCard.style.display='block'; tasksEmpty.style.display='block';
      }else{
        tasksCard.style.display='block'; tasksEmpty.style.display='none';
        
        // FIX: Calculate total seconds correctly based on the current mode (Focus vs Break)
        const mode = state ? state.mode : 'focus';
        const isFocus = mode === 'focus';
        const isRunning = state && state.running;
        
        let totalSeconds = (settings.focus || 25) * 60;
        if (mode === 'short') totalSeconds = (settings.short || 5) * 60;
        if (mode === 'long') totalSeconds = (settings.long || 15) * 60;

        const remaining = Math.max(0, (state && state.remaining != null ? state.remaining : totalSeconds));
        const progressDeg = 360 * (1 - (remaining / totalSeconds));

        openTasks.forEach((t,i)=>{
          const card=document.createElement('div'); card.className='htask-card htask';
          const circle=document.createElement('div'); circle.className='mini-circle';
          const leftSpan=document.createElement('span');
          
          /* SMART CLOCK LOGIC: Show time if running (Focus OR Break) */
          let displayContent = '‚ñ∂'; 
          
          if (isRunning) {
             if (isFocus) {
                 displayContent = fmtMMSS(remaining);
             } else {
                 // Break mode running: Mug + Timer perfectly centered in the circle
                 displayContent = `<div style="display:flex; flex-direction:column; align-items:center; line-height:1.1; margin-top:-2px"><span style="font-size:0.75em;">‚òï</span><span style="font-size:0.85em;">${fmtMMSS(remaining)}</span></div>`;
             }
          } else {
             displayContent = isFocus ? '‚ñ∂' : '‚òï'; 
          }

          // Apply to first task only
          if (i === 0) {
              leftSpan.innerHTML = displayContent;
          } else {
              leftSpan.textContent = (i + 1);
          }
          
          circle.appendChild(leftSpan);
          // Show progress bar if running (works for focus and breaks now)
          circle.style.setProperty('--prog',(i===0 && isRunning) ? `${progressDeg}deg` : '0deg');
          
          const meta=document.createElement('div'); meta.className='meta';
          const name=document.createElement('div'); name.className='name'; name.textContent=t.text;
          const sub=document.createElement('div'); sub.className='sub';
          
          // Subtitle Logic
          if(i===0) {
             if(isFocus) {
                sub.textContent = isRunning ? 'Focusing...' : 'Ready to Start';
             } else {
                sub.textContent = isRunning ? 'On Break ‚òï' : 'Break Paused ‚òï';
             }
          } else {
             sub.textContent = 'Queued';
          }

          meta.appendChild(name); meta.appendChild(sub);
          card.appendChild(circle); card.appendChild(meta);
          tasksWrap.appendChild(card);
        });
      }

      doneList.innerHTML='';
      if(done.length===0) doneCard.style.display='none';
      else{
        doneCard.style.display='block';
        done.forEach(t=>{ const row=document.createElement('div'); row.className='done-item'; row.innerHTML=`<span>${t.text}</span><span class="pill">${new Date(t.ts||Date.now()).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span>`; doneList.appendChild(row); });
      }
    }

    renderHomeFromPom();
    setInterval(renderHomeFromPom,1000);
    window.addEventListener('pom-tick',renderHomeFromPom);
    window.addEventListener('tasks-changed',renderHomeFromPom);
  </script>

  <script>
    (function(){
      // Only register service worker if on HTTP/HTTPS
      if('serviceWorker'in navigator && location.protocol.startsWith('http')){
        const swCode=`const CACHE='homer-v1'; const APP_SHELL=['/','/index.html'];
          self.addEventListener('install',e=>{ e.waitUntil(caches.open(CACHE).then(c=>c.addAll(APP_SHELL)).then(()=>self.skipWaiting())); })
          self.addEventListener('activate',e=>{ e.waitUntil(caches.keys().then(keys=>Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)))).then(()=>self.clients.claim())); })
          self.addEventListener('fetch',e=>{
            const url=new URL(e.request.url);
            const isExternal=url.origin!==self.location.origin;
            const isAPI=url.hostname.includes('open-meteo.com')
                      || url.hostname.includes('youtube.com')
                      || url.hostname.includes('googlevideo.com')
                      || url.hostname.includes('githubusercontent.com')
                      || url.hostname.includes('official-joke-api')
                      || url.hostname.includes('cdnjs.cloudflare.com');
            if(isExternal||isAPI){
              e.respondWith(fetch(e.request).catch(()=>new Response('',{status:503}))); return;
            }
            e.respondWith(fetch(e.request).then(res=>{const copy=res.clone(); caches.open(CACHE).then(c=>c.put(e.request,copy)); return res; }).catch(()=>caches.match(e.request)));
          })`;
        const swUrl=URL.createObjectURL(new Blob([swCode],{type:'text/javascript'}));
        window.addEventListener('load',()=>navigator.serviceWorker.register(swUrl).then(r=>r.update()).catch(()=>{}));
      }
    })();
  </script>
<script>
// üîµ AUDIO PLAYER WITH BULLETPROOF STATE TRACKING
const tracks = {
  ocean: { id:"WHPEKLQID4U", btn:"btn-ocean", vol:"vol-ocean", labelPlay:"‚ñ∂Ô∏è Play Ocean", labelPause:"‚è∏Ô∏è Pause Ocean", holder:"yt-ocean", isPlaying: false },
  fire:  { id:"UgHKb_7884o", btn:"btn-fire",  vol:"vol-fire",  labelPlay:"‚ñ∂Ô∏è Play Fireplace", labelPause:"‚è∏Ô∏è Pause Fireplace", holder:"yt-fire", isPlaying: false },
  rain:  { id:"mPZkdNFkNps", btn:"btn-rain",  vol:"vol-rain",  labelPlay:"‚ñ∂Ô∏è Play Rain", labelPause:"‚è∏Ô∏è Pause Rain", holder:"yt-rain", isPlaying: false },
  rainywindow: { id:"Dx5qFachd3A", btn:"btn-rainywindow", vol:"vol-rainywindow", labelPlay:"‚ñ∂Ô∏è Play Jazz", labelPause:"‚è∏Ô∏è Pause Jazz", holder:"yt-rainywindow", isPlaying: false },
  cafe:  { id:"uiMXGIG_DQo", btn:"btn-cafe",  vol:"vol-cafe",  labelPlay:"‚ñ∂Ô∏è Play Caf√©", labelPause:"‚è∏Ô∏è Pause Caf√©", holder:"yt-cafe", isPlaying: false },
  lofi:  { id:"Na0w3Mz46GA", btn:"btn-lofi",  vol:"vol-lofi",  labelPlay:"‚ñ∂Ô∏è Play Lo-Fi", labelPause:"‚è∏Ô∏è Pause Lo-Fi", holder:"yt-lofi", isPlaying: false },
  wind: { id:"jYu1-CxNqks", btn:"btn-wind", vol:"vol-wind", labelPlay:"‚ñ∂Ô∏è Play Wind", labelPause:"‚è∏Ô∏è Pause Wind", holder:"yt-wind", isPlaying: false },
  synthwave: { id:"4xDzrJKXOOY", btn:"btn-synthwave", vol:"vol-synthwave", labelPlay:"‚ñ∂Ô∏è Play Synthwave", labelPause:"‚è∏Ô∏è Pause Synthwave", holder:"yt-synthwave", isPlaying: false },
  weightless: { id:"vYIYIVmOo3Q", btn:null, vol:null, holder:"yt-weightless", isPlaying: false } 
};

function createPlayer(k) {
  const t = tracks[k];
  if(t.player) return;
  t.player = new YT.Player(t.holder, {
    height: "0", width: "0",
    videoId: t.id,
    playerVars: { autoplay: 1, controls: 0, loop: 1, playlist: t.id, modestbranding: 1 },
    events: {
      onReady: e => {
        const volEl = t.vol ? document.getElementById(t.vol) : null;
        if(volEl) e.target.setVolume(+volEl.value);
        // FIX: If the user toggled it off before it even finished loading, pause it immediately
        if(!t.isPlaying) {
            e.target.pauseVideo();
        }
      }
    }
  });
}

function togglePlay(k) {
  const t = tracks[k];
  const btn = document.getElementById(t.btn);
  
  if (!t.player) {
    createPlayer(k);
    t.isPlaying = true;
    if(btn) btn.textContent = t.labelPause;
    return;
  }
  
  // FIX: Rely on our strict internal state, not YouTube's delayed API state
  if (t.isPlaying) {
    t.player.pauseVideo();
    t.isPlaying = false;
    if(btn) btn.textContent = t.labelPlay;
  } else {
    t.player.playVideo();
    t.isPlaying = true;
    if(btn) btn.textContent = t.labelPause;
  }
}

function setVolume(k, v) {
  const t = tracks[k];
  if (t.player && typeof t.player.setVolume === "function") t.player.setVolume(v);
}

function stopAll() {
  Object.keys(tracks).forEach(k => {
    const t = tracks[k];
    t.isPlaying = false;
    if (t.player && typeof t.player.pauseVideo === 'function') t.player.pauseVideo();
    if (t.btn) {
        const btnEl = document.getElementById(t.btn);
        if(btnEl) btnEl.textContent = t.labelPlay;
    }
  });
}

function playMix(list) {
  stopAll();
  list.forEach(item => {
    const t = tracks[item.k];
    t.isPlaying = true;
    
    // Visually update the UI Slider to match the mix
    const volEl = document.getElementById(t.vol);
    if(volEl) volEl.value = item.vol;
    
    // Visually update the UI Button to show it is playing
    const btnEl = document.getElementById(t.btn);
    if(btnEl) btnEl.textContent = t.labelPause;

    if(!t.player) {
        createPlayer(item.k);
    } else {
        setTimeout(() => {
            if(typeof t.player.setVolume === 'function') {
                t.player.setVolume(item.vol);
                t.player.playVideo();
            }
        }, 100);
    }
  });
}

document.addEventListener("click", e => {
  const id = e.target.id;
  if (id === "stop-all") stopAll();
  if (id === "mix-sleep") playMix([{k:'fire',vol:40}, {k:'rain',vol:60}]);
  if (id === "mix-rainy") playMix([{k:'rain',vol:70}, {k:'ocean',vol:40}]);
  if (id === "mix-reading") playMix([{k:'lofi',vol:50}, {k:'fire',vol:10}, {k:'wind',vol:10}, {k:'rain',vol:10}]);
  if (id === "mix-cozy") playMix([{k:'fire',vol:40}, {k:'rain',vol:40}, {k:'rainywindow',vol:30}]);
  Object.keys(tracks).forEach(k => {
    if (id === tracks[k].btn) togglePlay(k);
  });
});

document.addEventListener("input", e => {
  Object.keys(tracks).forEach(k => {
    if (e.target.id === tracks[k].vol) setVolume(k, +e.target.value);
  });
});
</script>
<script src="https://www.youtube.com/iframe_api"></script>

<script>
  let noSleep = typeof NoSleep !== 'undefined' ? new NoSleep() : null;
  let wakeLockSentinel = null;
  let isKeepingAwake = false;
  const btnWake = document.getElementById('btn-wake');

  // FIX: Bulletproof Toggle for Keep Awake that won't conflict with background loops
  async function acquireWakeLock() {
      if ('wakeLock' in navigator) {
          try {
              wakeLockSentinel = await navigator.wakeLock.request('screen');
              wakeLockSentinel.addEventListener('release', () => { 
                  wakeLockSentinel = null; 
              });
          } catch (err) {}
      }
  }

  async function toggleWakeLock() {
      if (!isKeepingAwake) {
          // Turn ON
          isKeepingAwake = true;
          if (noSleep) noSleep.enable();
          await acquireWakeLock();
          
          if (btnWake) {
              btnWake.textContent = 'üëÄ Keeping Awake...';
              btnWake.classList.remove('danger');
              btnWake.classList.add('secondary');
          }
      } else {
          // Turn OFF
          isKeepingAwake = false;
          if (noSleep) noSleep.disable();
          
          if (wakeLockSentinel) {
              try { await wakeLockSentinel.release(); } catch(e) {}
              wakeLockSentinel = null;
          }
          
          if (btnWake) {
              btnWake.textContent = '‚òï Keep Awake';
              btnWake.classList.add('danger');
              btnWake.classList.remove('secondary');
          }
      }
  }

  if (btnWake) {
      btnWake.addEventListener('click', toggleWakeLock);
  }

  // Restore wake lock only if the user actively wants it kept awake
  document.addEventListener('visibilitychange', async () => {
      if (isKeepingAwake && document.visibilityState === 'visible' && !wakeLockSentinel) {
         await acquireWakeLock();
      }
  });

  setInterval(async () => {
      if (isKeepingAwake && document.visibilityState === 'visible' && !wakeLockSentinel) {
          await acquireWakeLock();
      }
  }, 10000);
</script>

<script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
  <script>
    let tvWidgetCreated = false;

    function initInvestingTab() {
      // 1. Fire up the Advanced Chart
      if (!tvWidgetCreated && typeof TradingView !== 'undefined') {
        new TradingView.widget({
          "autosize": true,
          "symbol": "AMEX:SPY", // Default to S&P 500 ETF
          "interval": "D",      // Daily candles
          "timezone": "Etc/UTC",
          "theme": "dark",
          "style": "1",         // Candlesticks
          "locale": "en",
          "enable_publishing": false,
          "backgroundColor": "rgba(15, 23, 42, 1)", // Matches your --bg #0f172a
          "gridColor": "rgba(255, 255, 255, 0.06)", // Matches your var(--border)
          "hide_top_toolbar": false,  // Enables timeframe & ticker search
          "hide_legend": false,       // Shows indicator values
          "hide_side_toolbar": false, // üî¥ THE FIX: Unhides the drawing tools (Trend lines, etc.)
          "allow_symbol_change": true, // Lets you freely type new tickers
          "save_image": false,
          "container_id": "tv_chart_container",
          "studies": [
            "Volume@tv-basicstudies",   // Volume
            "MASimple@tv-basicstudies", // Moving Average
            "RSI@tv-basicstudies"       // RSI
          ]
        });
        tvWidgetCreated = true;
      }

      // 2. Fetch Market News 
      const newsList = document.getElementById('investing-news-list');
      if (newsList && newsList.innerHTML.includes('spinner')) {
        fetch('https://api.rss2json.com/v1/api.json?rss_url=https://www.investing.com/rss/news_25.rss')
          .then(res => res.json())
          .then(data => {
            newsList.innerHTML = '';
            data.items.slice(0, 5).forEach(item => {
              const div = document.createElement('div');
              div.className = 'saved-item fade-in';
              div.innerHTML = `
                <div style="font-weight:800; margin-bottom:4px;">
                  <a href="${item.link}" target="_blank" style="color:var(--accent-2); text-decoration:none;">${item.title}</a>
                </div>
                <div class="saved-meta" style="margin-top:0;">${item.pubDate}</div>`;
              newsList.appendChild(div);
            });
          })
          .catch(() => {
            newsList.innerHTML = '<p class="muted">Failed to load news.</p>';
          });
      }
    }
  </script>
  
</body>
</html>
